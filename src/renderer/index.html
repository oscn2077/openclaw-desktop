<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenClaw Desktop</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="app">
    <!-- Sidebar -->
    <nav id="sidebar">
      <div class="logo">🦞 OpenClaw</div>
      <div class="nav-items">
        <button class="nav-item active" data-page="status" onclick="showPage('status')" title="">
          <span class="icon">📊</span> <span class="nav-label">状态</span>
        </button>
        <button class="nav-item" data-page="models" onclick="showPage('models')" title="">
          <span class="icon">🧠</span> <span class="nav-label">模型</span>
        </button>
        <button class="nav-item" data-page="channels" onclick="showPage('channels')" title="">
          <span class="icon">💬</span> <span class="nav-label">渠道</span>
        </button>
        <button class="nav-item" data-page="chat" onclick="showPage('chat')" title="">
          <span class="icon">🗨️</span> <span class="nav-label">对话</span>
        </button>
        <button class="nav-item" data-page="logs" onclick="showPage('logs')" title="">
          <span class="icon">📋</span> <span class="nav-label">日志</span>
        </button>
        <button class="nav-item" data-page="settings" onclick="showPage('settings')" title="">
          <span class="icon">⚙️</span> <span class="nav-label">设置</span>
        </button>
      </div>
      <div class="nav-footer">
        <div id="gateway-indicator" class="indicator stopped">
          <span class="dot"></span>
          <span class="text">已停止</span>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main id="content">
      <!-- Setup Wizard (shown on first run) -->
      <div id="page-wizard" class="page" style="display:none;">
        <div class="wizard">
          <div class="wizard-header">
            <h1>🦞 欢迎使用 OpenClaw Desktop</h1>
            <p>让我们花 2 分钟完成初始设置</p>
          </div>

          <!-- Progress Bar -->
          <div class="wizard-progress">
            <div class="progress-step active" id="progress-step-1">
              <div class="progress-dot">1</div>
              <span class="progress-label">环境检测</span>
            </div>
            <div class="progress-line" id="progress-line-1"></div>
            <div class="progress-step" id="progress-step-2">
              <div class="progress-dot">2</div>
              <span class="progress-label">模型配置</span>
            </div>
            <div class="progress-line" id="progress-line-2"></div>
            <div class="progress-step" id="progress-step-3">
              <div class="progress-dot">3</div>
              <span class="progress-label">渠道设置</span>
            </div>
          </div>

          <!-- Step 1: Environment Check -->
          <div class="wizard-step" id="step-1">
            <h2>第 1 步：环境检测</h2>
            <div id="env-check" class="check-list">
              <div class="check-item" id="check-os">
                <span class="check-icon">⏳</span>
                <span class="check-label">操作系统</span>
                <span class="check-value"></span>
              </div>
              <div class="check-item" id="check-node">
                <span class="check-icon">⏳</span>
                <span class="check-label">Node.js</span>
                <span class="check-value"></span>
              </div>
              <div class="check-item" id="check-openclaw">
                <span class="check-icon">⏳</span>
                <span class="check-label">OpenClaw</span>
                <span class="check-value"></span>
              </div>
            </div>
            <div id="env-actions" style="display:none;"></div>
            <div class="wizard-buttons">
              <button class="btn primary" id="btn-step1-next" onclick="wizardNext(2)" disabled>
                下一步 <span class="btn-arrow">→</span>
              </button>
            </div>
          </div>

          <!-- Step 2: Model Setup -->
          <div class="wizard-step" id="step-2" style="display:none;">
            <h2>第 2 步：配置 AI 模型</h2>
            <p class="hint">至少配置一个模型即可开始使用</p>

            <div class="model-cards">
              <!-- Claude -->
              <div class="model-card" id="model-claude">
                <div class="model-header">
                  <label><input type="checkbox" id="enable-claude" onchange="toggleModel('claude')"> Claude (Anthropic)</label>
                </div>
                <div class="model-body" style="display:none;">
                  <div class="form-group">
                    <label>接入方式</label>
                    <select id="claude-type" onchange="toggleProxyFields('claude')">
                      <option value="proxy" selected>中转 API</option>
                      <option value="official">官方 API</option>
                    </select>
                  </div>
                  <div class="form-group proxy-field" id="claude-proxy-url">
                    <label>中转地址</label>
                    <input type="text" id="claude-base-url" placeholder="https://yunyi.rdzhvip.com/claude" value="">
                    <span class="help-text">国内用 yunyi.rdzhvip.com/claude，国外用 yunyi.cfd/claude</span>
                  </div>
                  <div class="form-group">
                    <label>API Key（卡密）</label>
                    <input type="password" id="claude-api-key" placeholder="你的卡密">
                    <span class="validation-msg" id="claude-api-key-error"></span>
                  </div>
                  <div class="form-group">
                    <label>默认模型</label>
                    <select id="claude-model">
                      <option value="claude-opus-4-5">Claude Opus 4.5</option>
                      <option value="claude-opus-4-6">Claude Opus 4.6</option>
                      <option value="claude-sonnet-4-5">Claude Sonnet 4.5</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Codex (OpenAI) -->
              <div class="model-card" id="model-codex">
                <div class="model-header">
                  <label><input type="checkbox" id="enable-codex" onchange="toggleModel('codex')"> Codex (OpenAI)</label>
                </div>
                <div class="model-body" style="display:none;">
                  <div class="form-group">
                    <label>接入方式</label>
                    <select id="codex-type" onchange="toggleProxyFields('codex')">
                      <option value="proxy" selected>中转 API</option>
                      <option value="official">官方 API</option>
                    </select>
                  </div>
                  <div class="form-group proxy-field" id="codex-proxy-url">
                    <label>中转地址</label>
                    <input type="text" id="codex-base-url" placeholder="https://yunyi.rdzhvip.com/codex" value="">
                    <span class="help-text">国内用 yunyi.rdzhvip.com/codex，国外用 yunyi.cfd/codex</span>
                  </div>
                  <div class="form-group">
                    <label>API Key（卡密）</label>
                    <input type="password" id="codex-api-key" placeholder="你的卡密">
                    <span class="help-text">Claude 和 Codex 的卡密不互通，看你买的是哪个</span>
                    <span class="validation-msg" id="codex-api-key-error"></span>
                  </div>
                  <div class="form-group">
                    <label>默认模型</label>
                    <select id="codex-model">
                      <option value="gpt-5.2">GPT-5.2</option>
                      <option value="gpt-codex-5.3">GPT Codex 5.3</option>
                      <option value="gpt-4.1">GPT-4.1</option>
                      <option value="o3">o3</option>
                      <option value="o4-mini">o4-mini</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Gemini -->
              <div class="model-card" id="model-gemini">
                <div class="model-header">
                  <label><input type="checkbox" id="enable-gemini" onchange="toggleModel('gemini')"> Google Gemini</label>
                </div>
                <div class="model-body" style="display:none;">
                  <div class="form-group">
                    <label>API Key (Google AI Studio)</label>
                    <input type="password" id="gemini-api-key" placeholder="AIzaSy...">
                    <a href="#" onclick="api.openExternal('https://aistudio.google.com/apikey'); return false;" class="help-link">获取免费 API Key →</a>
                    <span class="validation-msg" id="gemini-api-key-error"></span>
                  </div>
                  <div class="form-group">
                    <label>默认模型</label>
                    <select id="gemini-model">
                      <option value="gemini-3-flash">Gemini 3 Flash</option>
                      <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                      <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- GLM -->
              <div class="model-card" id="model-glm">
                <div class="model-header">
                  <label><input type="checkbox" id="enable-glm" onchange="toggleModel('glm')"> 智谱 GLM</label>
                </div>
                <div class="model-body" style="display:none;">
                  <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="glm-api-key" placeholder="your-api-key">
                    <a href="#" onclick="api.openExternal('https://open.bigmodel.cn/'); return false;" class="help-link">获取 API Key →</a>
                    <span class="validation-msg" id="glm-api-key-error"></span>
                  </div>
                  <div class="form-group">
                    <label>默认模型</label>
                    <select id="glm-model">
                      <option value="glm-4.7-flash">GLM-4.7 Flash (免费)</option>
                      <option value="glm-4.7">GLM-4.7</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Test Connection Button -->
            <div class="wizard-test-connection" style="margin-top:16px;">
              <button class="btn" id="btn-test-connection" onclick="testWizardConnection()">
                <span class="btn-icon">🔗</span> 测试连接
              </button>
              <span id="test-connection-result" class="test-result"></span>
            </div>

            <div class="wizard-buttons">
              <button class="btn" onclick="wizardNext(1)">
                <span class="btn-arrow">←</span> 上一步
              </button>
              <button class="btn primary" id="btn-step2-next" onclick="wizardNext(3)">
                下一步 <span class="btn-arrow">→</span>
              </button>
            </div>
          </div>

          <!-- Step 3: Channel Setup -->
          <div class="wizard-step" id="step-3" style="display:none;">
            <h2>第 3 步：聊天渠道（可选）</h2>
            <p class="hint">先跳过也行，网页版聊天开箱即用</p>

            <div class="channel-cards">
              <div class="channel-card">
                <label><input type="checkbox" id="enable-telegram" onchange="toggleChannel('telegram')"> Telegram</label>
                <div class="channel-body" style="display:none;">
                  <div class="form-group">
                    <label>Bot Token</label>
                    <input type="password" id="telegram-token" placeholder="123456:ABC-DEF...">
                    <a href="#" onclick="api.openExternal('https://t.me/BotFather'); return false;" class="help-link">从 @BotFather 获取 →</a>
                  </div>
                </div>
              </div>

              <div class="channel-card">
                <label><input type="checkbox" id="enable-discord" onchange="toggleChannel('discord')"> Discord</label>
                <div class="channel-body" style="display:none;">
                  <div class="form-group">
                    <label>Bot Token</label>
                    <input type="password" id="discord-token" placeholder="your-bot-token">
                  </div>
                </div>
              </div>

              <div class="channel-card">
                <label><input type="checkbox" id="enable-feishu" onchange="toggleChannel('feishu')"> 飞书</label>
                <div class="channel-body" style="display:none;">
                  <div class="form-group">
                    <label>App ID</label>
                    <input type="text" id="feishu-app-id" placeholder="cli_xxx">
                  </div>
                  <div class="form-group">
                    <label>App Secret</label>
                    <input type="password" id="feishu-app-secret" placeholder="your-app-secret">
                  </div>
                </div>
              </div>

              <div class="channel-card disabled">
                <label>微信 <span class="badge">即将支持</span></label>
              </div>

              <div class="channel-card disabled">
                <label>钉钉 <span class="badge">即将支持</span></label>
              </div>
            </div>

            <div class="wizard-buttons">
              <button class="btn" onclick="wizardNext(2)">
                <span class="btn-arrow">←</span> 上一步
              </button>
              <button class="btn primary" onclick="finishWizard()">🚀 完成设置</button>
              <button class="btn" onclick="finishWizard()">跳过，直接开始</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Page -->
      <div id="page-status" class="page">
        <h1>📊 系统状态</h1>
        <div class="status-grid">
          <div class="status-card" id="status-gateway">
            <div class="status-title">Gateway</div>
            <div class="status-value" id="status-gateway-value">检测中...</div>
            <div class="status-actions">
              <button class="btn small primary" id="btn-start" onclick="startGateway()">启动</button>
              <button class="btn small danger" id="btn-stop" onclick="stopGateway()" style="display:none;">停止</button>
              <button class="btn small" id="btn-restart" onclick="restartGateway()" style="display:none;">重启</button>
            </div>
          </div>
          <div class="status-card">
            <div class="status-title">主模型</div>
            <div class="status-value" id="status-model">未配置</div>
            <div class="status-sub" id="status-model-provider"></div>
          </div>
          <div class="status-card">
            <div class="status-title">Fallback 链</div>
            <div class="status-value" id="status-fallbacks" style="font-size:14px;">无</div>
          </div>
          <div class="status-card">
            <div class="status-title">聊天渠道</div>
            <div class="status-value" id="status-channels">未配置</div>
          </div>
          <div class="status-card">
            <div class="status-title">WebChat</div>
            <div class="status-value">
              <a href="#" id="webchat-link" onclick="openWebChat(); return false;">打开网页聊天 →</a>
            </div>
          </div>
          <div class="status-card">
            <div class="status-title">Providers</div>
            <div class="status-value" id="status-providers">0</div>
          </div>
        </div>

        <!-- System Info Section -->
        <div class="section-card" id="status-sysinfo" style="margin-top:24px;">
          <div class="section-header">
            <h3>系统信息</h3>
            <button class="btn small" id="btn-copy-diagnostics" onclick="copyDiagnostics()">📋 复制诊断信息</button>
          </div>
          <div class="info-row">
            <span class="info-label">Node.js 版本</span>
            <span class="info-value" id="sysinfo-node">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">OpenClaw 版本</span>
            <span class="info-value" id="sysinfo-openclaw">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">操作系统</span>
            <span class="info-value" id="sysinfo-os">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">运行时间</span>
            <span class="info-value" id="sysinfo-uptime">-</span>
          </div>
        </div>

        <!-- Provider Status List -->
        <div id="status-provider-list" style="margin-top:24px;"></div>

        <!-- Gateway Logs Section -->
        <div class="section-card" id="status-logs-section" style="margin-top:24px;">
          <div class="section-header">
            <h3>Gateway 日志（最近 50 行）</h3>
            <button class="btn small" onclick="refreshStatusLogs()">🔄 刷新</button>
          </div>
          <pre id="status-log-output" class="log-box log-box-small"></pre>
        </div>
      </div>

      <!-- Models Page -->
      <div id="page-models" class="page" style="display:none;">
        <div class="page-header">
          <h1>🧠 模型管理</h1>
          <button class="btn primary" onclick="showAddProviderDialog()">+ 添加 Provider</button>
        </div>

        <!-- Current Model Info -->
        <div class="section-card" id="models-current">
          <h3>当前模型配置</h3>
          <div class="info-row">
            <span class="info-label">主模型</span>
            <span class="info-value" id="models-primary">未配置</span>
          </div>
          <div class="info-row">
            <span class="info-label">Fallback 链</span>
            <span class="info-value" id="models-fallbacks">无</span>
          </div>
        </div>

        <!-- Provider List -->
        <div id="provider-list" class="provider-list"></div>

        <!-- Add Provider Dialog (hidden by default) -->
        <div id="add-provider-dialog" class="dialog-overlay" style="display:none;">
          <div class="dialog">
            <div class="dialog-header">
              <h3>添加 Provider</h3>
              <button class="btn-close" onclick="hideAddProviderDialog()">✕</button>
            </div>
            <div class="dialog-body">
              <div class="form-group">
                <label>Provider ID</label>
                <input type="text" id="new-provider-id" placeholder="例如: my-openai">
                <span class="help-text">唯一标识符，只能用英文、数字和连字符</span>
              </div>
              <div class="form-group">
                <label>API 格式</label>
                <select id="new-provider-api">
                  <option value="anthropic-messages">Anthropic Messages (Claude 中转)</option>
                  <option value="openai-responses">OpenAI Responses (GPT/Codex 中转)</option>
                  <option value="openai-chat">OpenAI Chat Completions</option>
                </select>
              </div>
              <div class="form-group">
                <label>Base URL</label>
                <input type="text" id="new-provider-url" placeholder="https://api.example.com/v1">
              </div>
              <div class="form-group">
                <label>API Key</label>
                <input type="password" id="new-provider-key" placeholder="你的 API Key / 卡密">
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="new-provider-set-primary"> 设为主模型 Provider
                </label>
              </div>
              <div class="form-group" id="new-provider-model-group">
                <label>默认模型 ID</label>
                <input type="text" id="new-provider-model-id" placeholder="例如: claude-opus-4-6">
                <span class="help-text">设为主模型时需要填写</span>
              </div>
            </div>
            <div class="dialog-footer">
              <button class="btn" onclick="hideAddProviderDialog()">取消</button>
              <button class="btn primary" id="btn-add-provider" onclick="addProvider()">添加</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Channels Page -->
      <div id="page-channels" class="page" style="display:none;">
        <div class="page-header">
          <h1>💬 渠道管理</h1>
          <button class="btn primary" onclick="showAddChannelDialog()">+ 添加渠道</button>
        </div>

        <!-- Channel List -->
        <div id="channel-list" class="channel-list-manage"></div>

        <!-- Add Channel Dialog -->
        <div id="add-channel-dialog" class="dialog-overlay" style="display:none;">
          <div class="dialog">
            <div class="dialog-header">
              <h3>添加渠道</h3>
              <button class="btn-close" onclick="hideAddChannelDialog()">✕</button>
            </div>
            <div class="dialog-body">
              <div class="form-group">
                <label>渠道类型</label>
                <select id="new-channel-type" onchange="onChannelTypeChange()">
                  <option value="telegram">Telegram</option>
                  <option value="discord">Discord</option>
                </select>
              </div>
              <div class="form-group">
                <label>Bot Token</label>
                <input type="password" id="new-channel-token" placeholder="你的 Bot Token">
                <span class="help-text" id="new-channel-help">从 @BotFather 获取</span>
              </div>
              <div class="form-group" id="channel-allowed-users-group">
                <label>允许的用户 (可选)</label>
                <input type="text" id="new-channel-allowed-users" placeholder="用户ID，多个用逗号分隔">
                <span class="help-text">留空则所有人可用</span>
              </div>
            </div>
            <div class="dialog-footer">
              <button class="btn" onclick="hideAddChannelDialog()">取消</button>
              <button class="btn primary" id="btn-add-channel" onclick="addChannel()">添加</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Page -->
      <div id="page-chat" class="page" style="display:none;">
        <div class="page-header">
          <h1>🗨️ 对话</h1>
          <div class="chat-toolbar">
            <span class="chat-status" id="chat-status">
              <span class="dot"></span>
              <span class="chat-status-text">未连接</span>
            </span>
            <button class="btn small" onclick="openWebChatExternal()">
              <span class="btn-icon">🌐</span> 在浏览器中打开
            </button>
          </div>
        </div>
        <div id="chat-frame-container">
          <iframe id="chat-frame" style="width:100%;height:calc(100vh - 140px);border:1px solid var(--border);border-radius:8px;"></iframe>
        </div>
      </div>

      <!-- Logs Page -->
      <div id="page-logs" class="page" style="display:none;">
        <h1>📋 日志</h1>
        <pre id="log-output" class="log-box"></pre>
      </div>

      <!-- Settings Page -->
      <div id="page-settings" class="page" style="display:none;">
        <h1>⚙️ 设置</h1>

        <div class="settings-section">
          <h3>高级模式：配置文件编辑器</h3>
          <p class="hint">直接编辑 openclaw.json，修改后需重启 Gateway 生效</p>
          <div class="json-editor-container">
            <textarea id="json-editor" class="json-editor" spellcheck="false"></textarea>
            <div id="json-editor-error" class="json-error" style="display:none;"></div>
          </div>
          <div class="settings-actions">
            <button class="btn" onclick="loadJsonEditor()">重新加载</button>
            <button class="btn primary" id="btn-save-config" onclick="saveJsonEditor()">保存配置</button>
            <button class="btn" onclick="formatJsonEditor()">格式化</button>
          </div>
        </div>

        <div class="settings-section" style="margin-top:24px;">
          <h3>关于</h3>
          <div class="info-row">
            <span class="info-label">配置文件</span>
            <span class="info-value">~/.openclaw/openclaw.json</span>
          </div>
          <div class="info-row">
            <span class="info-label">工作目录</span>
            <span class="info-value">~/.openclaw/workspace</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Confirm Dialog (reusable) -->
  <div id="confirm-dialog" class="dialog-overlay" style="display:none;">
    <div class="dialog dialog-small">
      <div class="dialog-header">
        <h3 id="confirm-dialog-title">确认</h3>
        <button class="btn-close" onclick="hideConfirmDialog(false)">✕</button>
      </div>
      <div class="dialog-body">
        <p id="confirm-dialog-message"></p>
      </div>
      <div class="dialog-footer">
        <button class="btn" onclick="hideConfirmDialog(false)">取消</button>
        <button class="btn danger" id="confirm-dialog-ok" onclick="hideConfirmDialog(true)">确定</button>
      </div>
    </div>
  </div>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
